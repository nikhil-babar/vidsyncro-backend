AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    Timeout: 100
    Runtime: nodejs20.x
    Architectures:
    - x86_64
    Environment:
      Variables:
        REGION: us-east-2
        TRANSCODING_JOB_TOPIC: arn:aws:sns:us-east-2:037781008827:transcoding
        CLUSTER: vidsyncro-dev
        TRANSCODING_TASK: transcoding-task
        TRANSCODING_TASK_IMAGE: transcoding
        CLUSTER_SUBNET: subnet-0c12e2095badc3fc8
        CLUSTER_SECURITY_GROUP: sg-0df16e07936e89ef8
        VIDEO_BUCKET: vidsyncro-videos-bucket
        URL_EXPIRATION_SECONDS: 1000
        MONGO_URL: mongodb+srv://nikhilbabarjee:FSNAmZHHncz8ikqU@vidsycncro-cluster.9zc40jy.mongodb.net/?retryWrites=true&w=majority&appName=Vidsycncro-cluster
        MONGO_DB_NAME: vidysncro-db
Resources:
  PostAssetsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PostAssetsFunction
      Handler: src/api/assets/post-assets.handler
      Policies:
      - S3CrudPolicy:
          BucketName: vidsyncro-videos-bucket
      Events:
        PostAssets:
          Type: Api
          Properties:
            Path: /assets/v1/post-assets
            Method: post
    Metadata:
      SamResourceId: PostAssetsFunction
  GetAssetsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetAssetsFunction
      Handler: src/api/assets/get-assets.handler
      Policies:
      - S3CrudPolicy:
          BucketName: vidsyncro-videos-bucket
      Events:
        PostAssets:
          Type: Api
          Properties:
            Path: /assets/v1/get-assets
            Method: get
    Metadata:
      SamResourceId: GetAssetsFunction
  CreateProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreateProjectFunction
      Handler: src/api/project/create-project.handler
      Events:
        CreateProject:
          Type: Api
          Properties:
            Path: /project/v1/create-project
            Method: post
    Metadata:
      SamResourceId: CreateProjectFunction
  CreateTaskFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreateTaskFunction
      Handler: src/api/tasks/create-task.handler
      Policies:
      - SNSPublishMessagePolicy:
          TopicName: transcoding
      Events:
        CreateTask:
          Type: Api
          Properties:
            Path: /tasks/v1/create-tasks
            Method: post
    Metadata:
      SamResourceId: CreateTaskFunction
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: 'true'
Outputs:
  VidSyncroApi:
    Description: API Gateway endpoint URL for transcoding
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/
